#! /bin/sh /usr/share/dpatch/dpatch-run
## 102_CVE-2008-3790.dpatch by Jamie Strandboge <jamie@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Ubuntu: https://bugs.launchpad.net/bugs/261459
## DP: Upstream: http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=496808
## DP: Description: CVE-2008-3790

@DPATCH@
diff -urNad ruby1.8-1.8.6.111~/lib/rexml/document.rb ruby1.8-1.8.6.111/lib/rexml/document.rb
--- ruby1.8-1.8.6.111~/lib/rexml/document.rb	2008-10-07 13:31:26.000000000 -0500
+++ ruby1.8-1.8.6.111/lib/rexml/document.rb	2008-10-07 13:32:04.000000000 -0500
@@ -32,6 +32,7 @@
 	  # @param context if supplied, contains the context of the document;
 	  # this should be a Hash.
 		def initialize( source = nil, context = {} )
+			@entity_expansion_count = 0
 			super()
 			@context = context
 			return if source.nil?
@@ -200,6 +201,27 @@
 			Parsers::StreamParser.new( source, listener ).parse
 		end
 
+		@@entity_expansion_limit = 10_000
+
+		# Set the entity expansion limit. By defualt the limit is set to 10000.
+		def Document::entity_expansion_limit=( val )
+		  @@entity_expansion_limit = val
+		end
+
+		# Get the entity expansion limit. By defualt the limit is set to 10000.
+		def Document::entity_expansion_limit
+		  return @@entity_expansion_limit
+		end
+
+		attr_reader :entity_expansion_count
+
+		def record_entity_expansion
+		  @entity_expansion_count += 1
+		  if @entity_expansion_count > @@entity_expansion_limit
+		    raise "number of entity expansions exceeded, processing aborted."
+		  end
+		end
+
 		private
 		def build( source )
       Parsers::TreeParser.new( source, self ).parse
diff -urNad ruby1.8-1.8.6.111~/lib/rexml/entity.rb ruby1.8-1.8.6.111/lib/rexml/entity.rb
--- ruby1.8-1.8.6.111~/lib/rexml/entity.rb	2007-07-27 21:46:08.000000000 -0500
+++ ruby1.8-1.8.6.111/lib/rexml/entity.rb	2008-10-07 13:32:04.000000000 -0500
@@ -73,6 +73,7 @@
 		# all entities -- both %ent; and &ent; entities.  This differs from
 		# +value()+ in that +value+ only replaces %ent; entities.
 		def unnormalized
+			document.record_entity_expansion
 			v = value()
 			return nil if v.nil?
 			@unnormalized = Text::unnormalize(v, parent)
