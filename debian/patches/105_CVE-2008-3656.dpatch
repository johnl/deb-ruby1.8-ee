#! /bin/sh /usr/share/dpatch/dpatch-run
## 105_CVE-2008-3656.dpatch by Jamie Strandboge <jamie@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Ubuntu: https://bugs.launchpad.net/bugs/257122
## DP: Upstream: svn 1_8_6 r18347
## DP: Description: CVE-2008-3656

@DPATCH@
diff -urNad ruby1.8-1.8.6.111~/lib/webrick/httputils.rb ruby1.8-1.8.6.111/lib/webrick/httputils.rb
--- ruby1.8-1.8.6.111~/lib/webrick/httputils.rb	2007-02-12 17:01:19.000000000 -0600
+++ ruby1.8-1.8.6.111/lib/webrick/httputils.rb	2008-10-07 14:26:59.000000000 -0500
@@ -23,16 +23,8 @@
       ret = path.dup
 
       ret.gsub!(%r{/+}o, '/')                    # //      => /
-      while ret.sub!(%r{/\.(/|\Z)}o, '/'); end   # /.      => /
-      begin                                      # /foo/.. => /foo
-        match = ret.sub!(%r{/([^/]+)/\.\.(/|\Z)}o){
-          if $1 == ".."
-            raise "abnormal path `#{path}'"
-          else
-            "/"
-          end
-        }
-      end while match
+      while ret.sub!(%r'/\.(?:/|\Z)', '/'); end  # /.      => /
+      while ret.sub!(%r'/(?!\.\./)[^/]+/\.\.(?:/|\Z)', '/'); end # /foo/.. => /foo
 
       raise "abnormal path `#{path}'" if %r{/\.\.(/|\Z)} =~ ret
       ret
@@ -154,8 +146,8 @@
     module_function :parse_header
 
     def split_header_value(str)
-      str.scan(/((?:"(?:\\.|[^"])+?"|[^",]+)+)
-                (?:,\s*|\Z)/xn).collect{|v| v[0] }
+      str.scan(%r'\G((?:"(?:\\.|[^"])+?"|[^",]+)+)
+                    (?:,\s*|\Z)'xn).flatten
     end
     module_function :split_header_value
 
