#! /bin/sh /usr/share/dpatch/dpatch-run
## 107_CVE-2008-3657.dpatch by Jamie Strandboge <jamie@ubuntu.com>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: Upstream: svn 1_8_6 r18477
## DP: Description: CVE-2008-3657

@DPATCH@
diff -urNad ruby1.8-1.8.6.111~/ext/dl/dl.c ruby1.8-1.8.6.111/ext/dl/dl.c
--- ruby1.8-1.8.6.111~/ext/dl/dl.c	2007-03-19 02:43:56.000000000 -0500
+++ ruby1.8-1.8.6.111/ext/dl/dl.c	2008-10-07 14:50:05.000000000 -0500
@@ -522,12 +522,15 @@
 {
   char *ptr;
   int  len;
+  VALUE p;
 
   len = RSTRING(self)->len;
   ptr = (char*)dlmalloc(len + 1);
   memcpy(ptr, RSTRING(self)->ptr, len);
   ptr[len] = '\0';
-  return rb_dlptr_new((void*)ptr,len,dlfree);
+  p = rb_dlptr_new((void*)ptr,len,dlfree);
+  OBJ_INFECT(p, self);
+  return p;
 }
 
 VALUE
@@ -545,7 +548,12 @@
     ptr = rb_ary2cary(0, self, &size);
     break;
   }
-  return ptr ? rb_dlptr_new(ptr, size, dlfree) : Qnil;
+  if (ptr) {
+      VALUE p = rb_dlptr_new(ptr, size, dlfree);
+      OBJ_INFECT(p, self);
+      return p;
+  }
+  return Qnil;
 }
 
 VALUE
@@ -563,7 +571,7 @@
 VALUE
 rb_dl_dlopen(int argc, VALUE argv[], VALUE self)
 {
-  rb_secure(4);
+  rb_secure(2);
   return rb_class_new_instance(argc, argv, rb_cDLHandle);
 }
 
diff -urNad ruby1.8-1.8.6.111~/ext/dl/sym.c ruby1.8-1.8.6.111/ext/dl/sym.c
--- ruby1.8-1.8.6.111~/ext/dl/sym.c	2007-08-21 21:39:03.000000000 -0500
+++ ruby1.8-1.8.6.111/ext/dl/sym.c	2008-10-07 14:50:05.000000000 -0500
@@ -492,6 +492,7 @@
 	      rb_raise(rb_eDLTypeError, "unexpected type of argument #%d", i);
 	    }
 	  }
+	  rb_check_safe_obj(pval);
 	  Data_Get_Struct(pval, struct ptr_data, data);
 	  ANY2P(args[i]) = DLVOIDP(data->ptr);
 	}
